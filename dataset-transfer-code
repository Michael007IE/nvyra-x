# ------------------------------------------------------------------------------
#  CONFIDENTIAL AND PROPRIETARY
#  Copyright (c) 2025-2026 nvyra-x. All Rights Reserved.
#
#  NOTICE:  All information contained herein is, and remains the property of
#  nvyra-x. The intellectual and technical concepts contained herein are
#  proprietary to nvyra-x and may be covered by U.S. and Foreign Patents,
#  patents in process, and are protected by trade secret or copyright law.
#  Dissemination of this information or reproduction of this material is
#  strictly forbidden unless prior written permission is obtained from nvyra-x.
# ------------------------------------------------------------------------------
%%writefile import_zip.py
import modal
import os
import zipfile

app = modal.App("volume-importer")
# Creates the volume in the NEW account
vol = modal.Volume.from_name("rag-harvest-storage-prod", create_if_missing=True)

@app.function(volumes={"/data": vol}, timeout=1200)
def upload_volume(zip_bytes):
    print("üì¶ Received zip bytes. Saving to temp...")
    with open("/tmp/incoming.zip", "wb") as f:
        f.write(zip_bytes)
        
    print("üìÇ Extracting into Volume...")
    # Extract the zip file into the volume directory
    with zipfile.ZipFile("/tmp/incoming.zip", 'r') as z:
        z.extractall("/data")
        
    # Validation
    count = len(os.listdir("/data"))
    print(f"‚úÖ Success! Volume now contains {count} items.")

@app.local_entrypoint()
def main():
    input_file = "transfer_data.zip"
    if not os.path.exists(input_file):
        print(f"‚ùå Error: {input_file} not found. Did you run the export script?")
        return

    print(f"‚ö° Uploading {input_file} to new account...")
    with open(input_file, "rb") as f:
        data = f.read()
        
    upload_volume.remote(data)
    print("üéâ Transfer Complete!")

!modal run --detach import_zip.py
